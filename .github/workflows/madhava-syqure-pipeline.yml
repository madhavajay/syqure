name: Syqure Multistage (linux-x86_64)

on:
  workflow_dispatch:
  push:
    branches:
      - madhava/syqure
    paths-ignore:
      - "ci/artifacts.json"

permissions:
  contents: write
  actions: read
  packages: write

concurrency:
  group: syqure-linux-x86_64-${{ github.ref }}
  cancel-in-progress: false

jobs:
  configure-sequre:
    name: Sequre Configure (fail-fast)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install configure dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang cmake ninja-build pkg-config jq \
            libfmt-dev libedit-dev libxml2-dev zstd \
            libsodium-dev libssl-dev

      - name: Fetch cached Codon + LLVM artifacts
        run: |
          set -euo pipefail
          if [ ! -f ci/artifacts.json ]; then
            echo "ci/artifacts.json missing; skipping configure check." >&2
            exit 0
          fi
          CODON_RUN_ID="$(jq -r '.["linux-x86_64"].codon.run_id // empty' ci/artifacts.json)"
          CODON_ARTIFACT="$(jq -r '.["linux-x86_64"].codon.artifact // empty' ci/artifacts.json)"
          LLVM_RUN_ID="$(jq -r '.["linux-x86_64"].llvm.run_id // empty' ci/artifacts.json)"
          LLVM_ARTIFACT="$(jq -r '.["linux-x86_64"].llvm.artifact // empty' ci/artifacts.json)"
          if [ -z "$CODON_RUN_ID" ] || [ -z "$CODON_ARTIFACT" ] || [ -z "$LLVM_RUN_ID" ] || [ -z "$LLVM_ARTIFACT" ]; then
            echo "Cached artifacts not found in ci/artifacts.json; skipping configure check." >&2
            exit 0
          fi
          mkdir -p ci/_artifacts/codon ci/_artifacts/codon-llvm
          if ! gh run download "$CODON_RUN_ID" -n "$CODON_ARTIFACT" -D ci/_artifacts/codon; then
            echo "Failed to download Codon artifact; skipping configure check." >&2
            exit 0
          fi
          if ! gh run download "$LLVM_RUN_ID" -n "$LLVM_ARTIFACT" -D ci/_artifacts/codon-llvm; then
            echo "Failed to download LLVM artifact; skipping configure check." >&2
            exit 0
          fi
          CODON_TAR="$(ls ci/_artifacts/codon/codon-*.tar.zst | head -n 1)"
          mkdir -p ci/_artifacts/codon/extract
          zstd -dc "$CODON_TAR" | tar -C ci/_artifacts/codon/extract -xf -
          echo "CODON_PATH=$(pwd)/ci/_artifacts/codon/extract/codon" >> "$GITHUB_ENV"
          echo "LLVM_DIR=$(pwd)/ci/_artifacts/codon-llvm/install/lib/cmake/llvm" >> "$GITHUB_ENV"

      - name: Configure Sequre
        run: |
          cmake -S sequre -B sequre/build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCODON_PATH="$CODON_PATH" \
            -DCODON_SOURCE_DIR="$(pwd)/codon" \
            -DLLVM_DIR="$LLVM_DIR" \
            -DCMAKE_CXX_FLAGS="-I$(pwd)/compat" \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++

  build-linux-x86_64:
    runs-on: ubuntu-22.04
    needs: configure-sequre
    env:
      PLATFORM: linux-x86_64
      CODON_ARTIFACT_DIR: ci/_artifacts/codon
      SEQURE_ARTIFACT_DIR: ci/_artifacts/sequre
      SYQURE_ARTIFACT_DIR: ci/_artifacts/syqure
      CODON_LLVM_DIR: ci/_artifacts/codon-llvm
      LLVM_BRANCH: codon-17.0.6
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang lld cmake ninja-build pkg-config \
            zstd libzstd-dev libedit-dev libxml2-dev \
            python3 python3-venv python3-pip \
            libfmt-dev \
            libsodium-dev libssl-dev

      - name: Resolve provenance and build plan
        id: resolve
        run: |
          set -euo pipefail
          CODON_SHA="$(git -C codon rev-parse HEAD)"
          SEQURE_SHA="$(git -C sequre rev-parse HEAD)"
          SYQURE_SHA="$(git rev-parse HEAD)"
          LLVM_SHA="$(git ls-remote https://github.com/exaloop/llvm-project refs/heads/${LLVM_BRANCH} | awk '{print $1}')"
          VERSION="$(cat VERSION)"
          DOCKER_SHA="$SYQURE_SHA"
          echo "codon_sha=$CODON_SHA" >> "$GITHUB_OUTPUT"
          echo "sequre_sha=$SEQURE_SHA" >> "$GITHUB_OUTPUT"
          echo "syqure_sha=$SYQURE_SHA" >> "$GITHUB_OUTPUT"
          echo "llvm_sha=$LLVM_SHA" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "docker_sha=$DOCKER_SHA" >> "$GITHUB_OUTPUT"

          if [ -f ci/artifacts.json ]; then
            CODON_PREV_SHA="$(jq -r '.["linux-x86_64"].codon.sha // empty' ci/artifacts.json)"
            SEQURE_PREV_SHA="$(jq -r '.["linux-x86_64"].sequre.sha // empty' ci/artifacts.json)"
            SYQURE_PREV_SHA="$(jq -r '.["linux-x86_64"].syqure.sha // empty' ci/artifacts.json)"
            LLVM_PREV_SHA="$(jq -r '.["linux-x86_64"].llvm.sha // empty' ci/artifacts.json)"
            DOCKER_PREV_SHA="$(jq -r '.["linux-x86_64"].docker.sha // empty' ci/artifacts.json)"
            CODON_RUN_ID="$(jq -r '.["linux-x86_64"].codon.run_id // empty' ci/artifacts.json)"
            SEQURE_RUN_ID="$(jq -r '.["linux-x86_64"].sequre.run_id // empty' ci/artifacts.json)"
            SYQURE_RUN_ID="$(jq -r '.["linux-x86_64"].syqure.run_id // empty' ci/artifacts.json)"
            LLVM_RUN_ID="$(jq -r '.["linux-x86_64"].llvm.run_id // empty' ci/artifacts.json)"
            DOCKER_RUN_ID="$(jq -r '.["linux-x86_64"].docker.run_id // empty' ci/artifacts.json)"
            CODON_ARTIFACT="$(jq -r '.["linux-x86_64"].codon.artifact // empty' ci/artifacts.json)"
            SEQURE_ARTIFACT="$(jq -r '.["linux-x86_64"].sequre.artifact // empty' ci/artifacts.json)"
            SYQURE_ARTIFACT="$(jq -r '.["linux-x86_64"].syqure.artifact // empty' ci/artifacts.json)"
            LLVM_ARTIFACT="$(jq -r '.["linux-x86_64"].llvm.artifact // empty' ci/artifacts.json)"
            DOCKER_ARTIFACT="$(jq -r '.["linux-x86_64"].docker.artifact // empty' ci/artifacts.json)"
          else
            CODON_PREV_SHA=""
            SEQURE_PREV_SHA=""
            SYQURE_PREV_SHA=""
            LLVM_PREV_SHA=""
            DOCKER_PREV_SHA=""
            CODON_RUN_ID=""
            SEQURE_RUN_ID=""
            SYQURE_RUN_ID=""
            LLVM_RUN_ID=""
            DOCKER_RUN_ID=""
            CODON_ARTIFACT=""
            SEQURE_ARTIFACT=""
            SYQURE_ARTIFACT=""
            LLVM_ARTIFACT=""
            DOCKER_ARTIFACT=""
          fi

          lookup_run_id() {
            local name="$1"
            if [ -z "$name" ]; then
              return 0
            fi
            gh api "/repos/${GITHUB_REPOSITORY}/actions/artifacts" --paginate \
              --jq ".artifacts[] | select(.name==\"${name}\") | .workflow_run.id" | head -n 1
          }

          if [ -z "$CODON_ARTIFACT" ]; then
            CODON_ARTIFACT="codon-${PLATFORM}-${CODON_SHA}"
          fi
          if [ -z "$CODON_RUN_ID" ]; then
            CODON_RUN_ID="$(lookup_run_id "$CODON_ARTIFACT")"
          fi
          if [ -z "$LLVM_ARTIFACT" ]; then
            LLVM_ARTIFACT="codon-llvm-${PLATFORM}-${LLVM_SHA}"
          fi
          if [ -z "$LLVM_RUN_ID" ]; then
            LLVM_RUN_ID="$(lookup_run_id "$LLVM_ARTIFACT")"
          fi
          if [ -z "$SEQURE_ARTIFACT" ]; then
            SEQURE_ARTIFACT="sequre-${PLATFORM}-${SEQURE_SHA}"
          fi
          if [ -z "$SEQURE_RUN_ID" ]; then
            SEQURE_RUN_ID="$(lookup_run_id "$SEQURE_ARTIFACT")"
          fi
          if [ -z "$SYQURE_ARTIFACT" ]; then
            SYQURE_ARTIFACT="syqure-${PLATFORM}-${SYQURE_SHA}"
          fi
          if [ -z "$SYQURE_RUN_ID" ]; then
            SYQURE_RUN_ID="$(lookup_run_id "$SYQURE_ARTIFACT")"
          fi
          if [ -z "$DOCKER_ARTIFACT" ]; then
            DOCKER_ARTIFACT="syqure-cli-${PLATFORM}-${DOCKER_SHA}"
          fi
          if [ -z "$DOCKER_RUN_ID" ]; then
            DOCKER_RUN_ID="$(lookup_run_id "$DOCKER_ARTIFACT")"
          fi

          CODON_NEEDS_BUILD="false"
          SEQURE_NEEDS_BUILD="false"
          SYQURE_NEEDS_BUILD="false"
          LLVM_NEEDS_BUILD="false"
          DOCKER_NEEDS_BUILD="false"

          if [ "$CODON_PREV_SHA" != "$CODON_SHA" ] || [ -z "$CODON_RUN_ID" ] || [ -z "$CODON_ARTIFACT" ]; then
            CODON_NEEDS_BUILD="true"
          fi
          if [ "$LLVM_PREV_SHA" != "$LLVM_SHA" ] || [ -z "$LLVM_RUN_ID" ] || [ -z "$LLVM_ARTIFACT" ]; then
            LLVM_NEEDS_BUILD="true"
          fi
          if [ "$SEQURE_PREV_SHA" != "$SEQURE_SHA" ] || [ -z "$SEQURE_RUN_ID" ] || [ -z "$SEQURE_ARTIFACT" ] || [ "$CODON_NEEDS_BUILD" = "true" ]; then
            SEQURE_NEEDS_BUILD="true"
          fi
          if [ "$SYQURE_PREV_SHA" != "$SYQURE_SHA" ] || [ -z "$SYQURE_RUN_ID" ] || [ -z "$SYQURE_ARTIFACT" ] || [ "$SEQURE_NEEDS_BUILD" = "true" ]; then
            SYQURE_NEEDS_BUILD="true"
          fi
          if [ "$DOCKER_PREV_SHA" != "$DOCKER_SHA" ] || [ -z "$DOCKER_RUN_ID" ] || [ -z "$DOCKER_ARTIFACT" ] || [ "$SYQURE_NEEDS_BUILD" = "true" ]; then
            DOCKER_NEEDS_BUILD="true"
          fi

          echo "codon_needs_build=$CODON_NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "sequre_needs_build=$SEQURE_NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "syqure_needs_build=$SYQURE_NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "llvm_needs_build=$LLVM_NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "docker_needs_build=$DOCKER_NEEDS_BUILD" >> "$GITHUB_OUTPUT"
          echo "codon_run_id=$CODON_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "sequre_run_id=$SEQURE_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "syqure_run_id=$SYQURE_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "llvm_run_id=$LLVM_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "docker_run_id=$DOCKER_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "codon_artifact=$CODON_ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "sequre_artifact=$SEQURE_ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "syqure_artifact=$SYQURE_ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "llvm_artifact=$LLVM_ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "docker_artifact=$DOCKER_ARTIFACT" >> "$GITHUB_OUTPUT"

      - name: Build Codon (if needed)
        if: steps.resolve.outputs.codon_needs_build == 'true'
        run: |
          export CODON_ENABLE_OPENMP=OFF
          ./compile_codon_linux.sh
          mkdir -p "$CODON_ARTIFACT_DIR"
          tar -C bin -c codon | zstd -19 -o "$CODON_ARTIFACT_DIR/codon-${PLATFORM}-${{ steps.resolve.outputs.codon_sha }}.tar.zst"

      - name: Upload Codon artifact
        if: steps.resolve.outputs.codon_needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codon-${{ env.PLATFORM }}-${{ steps.resolve.outputs.codon_sha }}
          path: ${{ env.CODON_ARTIFACT_DIR }}/codon-${{ env.PLATFORM }}-${{ steps.resolve.outputs.codon_sha }}.tar.zst
          retention-days: 30

      - name: Download Codon artifact (cached)
        if: steps.resolve.outputs.codon_needs_build != 'true'
        run: |
          mkdir -p "$CODON_ARTIFACT_DIR"
          gh run download "${{ steps.resolve.outputs.codon_run_id }}" -n "${{ steps.resolve.outputs.codon_artifact }}" -D "$CODON_ARTIFACT_DIR"

      - name: Extract Codon artifact
        run: |
          CODON_TAR="$(ls "$CODON_ARTIFACT_DIR"/codon-${PLATFORM}-*.tar.zst | head -n 1)"
          mkdir -p "$CODON_ARTIFACT_DIR/extract"
          zstd -dc "$CODON_TAR" | tar -C "$CODON_ARTIFACT_DIR/extract" -xf -
          echo "CODON_PATH=$CODON_ARTIFACT_DIR/extract/codon" >> "$GITHUB_ENV"

      - name: Restore Codon LLVM cache
        id: llvm-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.CODON_LLVM_DIR }}
          key: codon-llvm-${{ runner.os }}-${{ runner.arch }}-${{ steps.resolve.outputs.llvm_sha }}
          restore-keys: |
            codon-llvm-${{ runner.os }}-${{ runner.arch }}-

      - name: Download Codon LLVM artifact (cached)
        if: steps.resolve.outputs.llvm_needs_build != 'true'
        run: |
          mkdir -p "$CODON_LLVM_DIR"
          if ! gh run download "${{ steps.resolve.outputs.llvm_run_id }}" -n "${{ steps.resolve.outputs.llvm_artifact }}" -D "$CODON_LLVM_DIR"; then
            echo "LLVM artifact download failed; continuing with cache/build." >&2
          fi

      - name: Build Codon LLVM (cached)
        run: |
          set -euo pipefail
          if [ -d "${CODON_LLVM_DIR}/install/lib/cmake/llvm" ]; then
            if ls "${CODON_LLVM_DIR}/install/lib"/libLLVM*.so* >/dev/null 2>&1; then
              echo "Using cached Codon LLVM at ${CODON_LLVM_DIR}"
              exit 0
            fi
            echo "Cached LLVM missing libLLVM.so; rebuilding with LLVM_BUILD_LLVM_DYLIB=ON"
          fi
          rm -rf "${CODON_LLVM_DIR}"
          git clone --depth 1 -b "${LLVM_BRANCH}" https://github.com/exaloop/llvm-project "${CODON_LLVM_DIR}"
          cmake -S "${CODON_LLVM_DIR}/llvm" -B "${CODON_LLVM_DIR}/build" -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_ENABLE_RTTI=ON \
            -DLLVM_ENABLE_ZLIB=OFF \
            -DLLVM_ENABLE_TERMINFO=OFF \
            -DLLVM_BUILD_LLVM_DYLIB=ON \
            -DLLVM_LINK_LLVM_DYLIB=ON \
            -DLLVM_TARGETS_TO_BUILD=all \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          cmake --build "${CODON_LLVM_DIR}/build"
          cmake --install "${CODON_LLVM_DIR}/build" --prefix "${CODON_LLVM_DIR}/install"

      - name: Save Codon LLVM cache
        if: steps.llvm-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.CODON_LLVM_DIR }}
          key: codon-llvm-${{ runner.os }}-${{ runner.arch }}-${{ steps.resolve.outputs.llvm_sha }}

      - name: Upload Codon LLVM artifact
        if: steps.resolve.outputs.llvm_needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codon-llvm-${{ env.PLATFORM }}-${{ steps.resolve.outputs.llvm_sha }}
          path: ${{ env.CODON_LLVM_DIR }}/install
          retention-days: 30
      - name: Build Sequre (if needed)
        if: steps.resolve.outputs.sequre_needs_build == 'true'
        env:
          LLVM_PATH: ${{ env.CODON_LLVM_DIR }}
        run: |
          CODON_PATH="$CODON_PATH" ./compile_sequre.sh
          mkdir -p "$SEQURE_ARTIFACT_DIR"
          tar -C "$(dirname "$CODON_PATH")" -c "$(basename "$CODON_PATH")" | zstd -19 -o "$SEQURE_ARTIFACT_DIR/sequre-${PLATFORM}-${{ steps.resolve.outputs.sequre_sha }}.tar.zst"

      - name: Upload Sequre artifact
        if: steps.resolve.outputs.sequre_needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sequre-${{ env.PLATFORM }}-${{ steps.resolve.outputs.sequre_sha }}
          path: ${{ env.SEQURE_ARTIFACT_DIR }}/sequre-${{ env.PLATFORM }}-${{ steps.resolve.outputs.sequre_sha }}.tar.zst
          retention-days: 30

      - name: Download Sequre artifact (cached)
        if: steps.resolve.outputs.sequre_needs_build != 'true'
        run: |
          mkdir -p "$SEQURE_ARTIFACT_DIR"
          gh run download "${{ steps.resolve.outputs.sequre_run_id }}" -n "${{ steps.resolve.outputs.sequre_artifact }}" -D "$SEQURE_ARTIFACT_DIR"

      - name: Extract Sequre artifact
        run: |
          SEQURE_TAR="$(ls "$SEQURE_ARTIFACT_DIR"/sequre-${PLATFORM}-*.tar.zst | head -n 1)"
          mkdir -p "$SEQURE_ARTIFACT_DIR/extract"
          zstd -dc "$SEQURE_TAR" | tar -C "$SEQURE_ARTIFACT_DIR/extract" -xf -
          echo "CODON_PATH=$SEQURE_ARTIFACT_DIR/extract/codon" >> "$GITHUB_ENV"

      - name: Build Syqure (if needed)
        if: steps.resolve.outputs.syqure_needs_build == 'true'
        run: |
          CODON_PATH="$CODON_PATH" ./bin_libs.sh
          export SYQURE_BUNDLE_FILE="$(pwd)/syqure/bundles/$(rustc -vV | awk '/host:/{print $2}').tar.zst"
          cargo build -p syqure
          mkdir -p "$SYQURE_ARTIFACT_DIR"
          tar -C . -c \
            target/debug/syqure \
            syqure/bundles/*.tar.zst | zstd -19 -o "$SYQURE_ARTIFACT_DIR/syqure-${PLATFORM}-${{ steps.resolve.outputs.syqure_sha }}.tar.zst"

      - name: Upload Syqure artifact
        if: steps.resolve.outputs.syqure_needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: syqure-${{ env.PLATFORM }}-${{ steps.resolve.outputs.syqure_sha }}
          path: ${{ env.SYQURE_ARTIFACT_DIR }}/syqure-${{ env.PLATFORM }}-${{ steps.resolve.outputs.syqure_sha }}.tar.zst
          retention-days: 30

      - name: Download Syqure artifact (cached)
        if: steps.resolve.outputs.syqure_needs_build != 'true'
        run: |
          mkdir -p "$SYQURE_ARTIFACT_DIR"
          gh run download "${{ steps.resolve.outputs.syqure_run_id }}" -n "${{ steps.resolve.outputs.syqure_artifact }}" -D "$SYQURE_ARTIFACT_DIR"

      - name: Extract Syqure artifact
        run: |
          SYQURE_TAR="$(ls "$SYQURE_ARTIFACT_DIR"/syqure-${PLATFORM}-*.tar.zst | head -n 1)"
          mkdir -p "$SYQURE_ARTIFACT_DIR/extract"
          zstd -dc "$SYQURE_TAR" | tar -C "$SYQURE_ARTIFACT_DIR/extract" -xf -

      - name: Build and publish Docker image (if needed)
        if: steps.resolve.outputs.docker_needs_build == 'true'
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/syqure-cli
        run: |
          set -euo pipefail
          VERSION="$(cat VERSION)"
          DOCKER_CTX="ci/_docker"
          rm -rf "$DOCKER_CTX"
          mkdir -p "$DOCKER_CTX/target/debug" "$DOCKER_CTX/bin/codon/lib"
          cp "$SYQURE_ARTIFACT_DIR/extract/target/debug/syqure" "$DOCKER_CTX/target/debug/"
          cp -R "$SEQURE_ARTIFACT_DIR/extract/codon/lib/codon" "$DOCKER_CTX/bin/codon/lib/"
          cp -R example "$DOCKER_CTX/example"
          cp docker/Dockerfile.syqure "$DOCKER_CTX/Dockerfile.syqure"
          echo "$GH_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          docker build -f "$DOCKER_CTX/Dockerfile.syqure" \
            -t "$IMAGE_NAME:$VERSION" \
            -t "$IMAGE_NAME:latest" \
            "$DOCKER_CTX"
          docker push "$IMAGE_NAME:$VERSION"
          docker push "$IMAGE_NAME:latest"
          mkdir -p "$SYQURE_ARTIFACT_DIR"
          docker save "$IMAGE_NAME:$VERSION" | zstd -19 -o \
            "$SYQURE_ARTIFACT_DIR/syqure-cli-${PLATFORM}-${{ steps.resolve.outputs.docker_sha }}.tar.zst"

      - name: Upload Docker artifact
        if: steps.resolve.outputs.docker_needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: syqure-cli-${{ env.PLATFORM }}-${{ steps.resolve.outputs.docker_sha }}
          path: ${{ env.SYQURE_ARTIFACT_DIR }}/syqure-cli-${{ env.PLATFORM }}-${{ steps.resolve.outputs.docker_sha }}.tar.zst
          retention-days: 30

      - name: Smoke test
        run: |
          export SYQURE_BUNDLE_FILE="$SYQURE_ARTIFACT_DIR/extract/syqure/bundles/$(rustc -vV | awk '/host:/{print $2}').tar.zst"
          export SYQURE_BUNDLE_CACHE="$SYQURE_ARTIFACT_DIR/extract/target/syqure-cache"
          rm -rf "$SYQURE_BUNDLE_CACHE"
          "$SYQURE_ARTIFACT_DIR/extract/target/debug/syqure" example/two_party_sum_simple.codon

      - name: Update provenance file
        if: |
          steps.resolve.outputs.codon_needs_build == 'true' ||
          steps.resolve.outputs.llvm_needs_build == 'true' ||
          steps.resolve.outputs.sequre_needs_build == 'true' ||
          steps.resolve.outputs.syqure_needs_build == 'true' ||
          steps.resolve.outputs.docker_needs_build == 'true'
        run: |
          set -euo pipefail
          CODON_ARTIFACT="codon-${PLATFORM}-${{ steps.resolve.outputs.codon_sha }}"
          LLVM_ARTIFACT="codon-llvm-${PLATFORM}-${{ steps.resolve.outputs.llvm_sha }}"
          SEQURE_ARTIFACT="sequre-${PLATFORM}-${{ steps.resolve.outputs.sequre_sha }}"
          SYQURE_ARTIFACT="syqure-${PLATFORM}-${{ steps.resolve.outputs.syqure_sha }}"
          DOCKER_ARTIFACT="syqure-cli-${PLATFORM}-${{ steps.resolve.outputs.docker_sha }}"

          python3 - <<'PY'
          import json
          from pathlib import Path
          path = Path("ci/artifacts.json")
          data = {"linux-x86_64": {"codon": None, "sequre": None, "syqure": None, "llvm": None, "docker": None}}
          if path.exists():
              data = json.loads(path.read_text())
          plat = data.setdefault("linux-x86_64", {})
          plat["codon"] = {
              "sha": "${{ steps.resolve.outputs.codon_sha }}",
              "run_id": "${{ github.run_id }}",
              "artifact": "codon-${{ env.PLATFORM }}-${{ steps.resolve.outputs.codon_sha }}",
          }
          plat["llvm"] = {
              "sha": "${{ steps.resolve.outputs.llvm_sha }}",
              "run_id": "${{ github.run_id }}",
              "artifact": "codon-llvm-${{ env.PLATFORM }}-${{ steps.resolve.outputs.llvm_sha }}",
          }
          plat["sequre"] = {
              "sha": "${{ steps.resolve.outputs.sequre_sha }}",
              "run_id": "${{ github.run_id }}",
              "artifact": "sequre-${{ env.PLATFORM }}-${{ steps.resolve.outputs.sequre_sha }}",
          }
          plat["syqure"] = {
              "sha": "${{ steps.resolve.outputs.syqure_sha }}",
              "run_id": "${{ github.run_id }}",
              "artifact": "syqure-${{ env.PLATFORM }}-${{ steps.resolve.outputs.syqure_sha }}",
          }
          plat["docker"] = {
              "sha": "${{ steps.resolve.outputs.docker_sha }}",
              "run_id": "${{ github.run_id }}",
              "artifact": "syqure-cli-${{ env.PLATFORM }}-${{ steps.resolve.outputs.docker_sha }}",
          }
          path.parent.mkdir(parents=True, exist_ok=True)
          path.write_text(json.dumps(data, indent=2, sort_keys=True) + "\n")
          PY

      - name: Commit provenance
        if: |
          steps.resolve.outputs.codon_needs_build == 'true' ||
          steps.resolve.outputs.llvm_needs_build == 'true' ||
          steps.resolve.outputs.sequre_needs_build == 'true' ||
          steps.resolve.outputs.syqure_needs_build == 'true' ||
          steps.resolve.outputs.docker_needs_build == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add ci/artifacts.json
          git commit -m "ci: record linux-x86_64 artifacts [skip ci]" || exit 0
          git push
